---
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: spacelab           # flatly spacelab sandstone cerulean
    code_download: true
---




***

# Revision History

**This version**  
  
*Current version: 1*  
Date report generated: `r format(Sys.time(), '%d %B, %Y')`  
Report prepared for: Name  
Purpose of report:  

* Exercise to analyze RNA-Seq data  

**Previous revisions**  

N/A  

***


# TODO: Rmd parameters like author and prepared for should be in the config

This report is meant to help explore DESeq2 results and was generated using RMarkdown. This section contains the code for setting up the rest of the report.  

## Load libraries

```{r docSetup, warning = FALSE, message = FALSE}
library('tidyverse')
library('knitr')
library('kableExtra')
library('DESeq2')

```


```{r extra stuff}

source(here::here("scripts","file_functions.R"))
source(here::here("scripts","setup_functions.R"))
source(here::here("scripts","setup_functions.R"))


config <- yaml::read_yaml(file.path(here::here(),
                                    "config/config.yaml"),
                          eval.expr = T)

# Combine required params from config
params <- c(config$common, config$DESeq2)
# replace nulls in params with NA
params <- replace_nulls_in_config(params)
# If projectdir is not set, figure out current project root directory
projectdir <- params$projectdir
if (is.na(projectdir)) {
  projectdir <- here::here()
  params$projectdir <- projectdir
}

paths <- set_up_paths(params)


skip_extra <- c("DMSO") # Remove DMSO controls as a facet

# Input file - Rmd
inputFile <- file.path(projectdir, "Rmd", "DESeq2_report_new.Rmd")

# Identify where metadata can be found
SampleKeyFile <- file.path(projectdir, "data/metadata/metadata.QC_applied.txt")

params$dataFile <- file.path(paths$DEG_output, paste0(params$project_name, "_DEG_data.RData"))


```


## load functions
```{r load_functions}

source(here::here("scripts","file_functions.R"))
source(here::here("scripts","setup_functions.R"))
source(here::here("scripts","setup_functions.R"))

species_data <- load_species(params$species)

bs <- load_biospyder_new(params$biospyder_dbs, species_data$temposeq_manifest)

```

## load config
```{r load_config}

config <- yaml::read_yaml(file.path(here::here(),
                                    "config/config.yaml"),
                          eval.expr = T)


```


```{r load_data}
load(params$dataFile) # metadata, contrasts, counts, resultsList

# reformat data based on group_facet and display_group_facet
if(is.na(params$group_facet) && is.na(params$display_group_facet)){
    dds <- ddsList[['all']]
    resultsList <- overallResList[['all']]
    rld <- rldList[['all']]
}

```

# descriptive plots

# Volcano plots (14) -- gives a good high level summary at a glance

# PCA plots (all genes, DEGs only, top 1000 most variable genes)
```{r PCA, collapse=TRUE}
# all genes
plotPCA(rld, intgroup = params$design, ntop = nrow(assay(rld))) +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(ncol = 3))
# DEGs only
plotPCA(rld[rownames(res)], intgroup = params$design, ntop = nrow(assay(rld))) +
    theme(legend.position = "bottom") +
    guides(color = guide_legend(ncol = 3))
# top N most variable
topN <- 100
most_variable <- res[order(-abs(res$log2FoldChange)),]
plotPCA(rld[rownames(most_variable[1:topN,])], intgroup = params$design, ntop = nrow(assay(rld))) +
    theme(legend.position = "bottom") +
    guides(color = guide_legend(ncol = 3))

```


# DEG heatmaps
# Heatmaps (18) -- I also like these but would consider dropping the row variance based one entirely, because I think it can be misleading

```{r DEG_heatmaps}
mat <- assay(rld)[row.names(assay(rld)) %in%
                                          res[[bs$biomart_filter]],
                  , drop = F] # Otherwise will return numeric for 1 row matrix
if (nrow(as.matrix(mat)) > 1) {
  mat <- mat - rowMeans(mat)
  pheatmap(mat,
           annotation_col = heatmap_df,
           show_rownames = FALSE,
           border_color = NA,
           scale = "row")
  # color = inferno(10)
} else {
  print("No DEGs found.")
}
```

# Genes of interest (13) -- often one the first things I'll look at myself... it shows upfront any big trends and whether genes you recognize are where they should be
```{r genes_of_interest}

```

# Gene-level plots for top 20 features -- maybe we could cut this to 10, since we will have the data exploration plot. Maybe even make it a tabset? I do like having it myself because it gives granularity at the sample level - how much spread is in the data... are dose-response trends looking reasonable or not across doses...
```{r genelevel_plots}


```

# methods summary
# references

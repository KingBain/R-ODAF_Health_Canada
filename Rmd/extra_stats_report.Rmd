---
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
    theme: spacelab           # flatly spacelab sandstone cerulean
    code_download: true
---

```{r docSetup, warning = FALSE, message = FALSE}
#### Record start time
startTime <- Sys.time()

library('tidyverse')
library('knitr')
library('kableExtra')
library('DESeq2')
library('RColorBrewer')
library('pheatmap')
library('data.table')

#source(here::here("scripts","file_functions.R"))
#source(here::here("scripts","setup_functions.R"))
source(here::here("scripts","DESeq_functions.R"))
source(here::here("scripts","data_functions.R"))

#########################################
# # to delete, should all be done by the render_DEseq2_reports.R script. Just in here to help with development
# 
# 
# config <- yaml::read_yaml(file.path(here::here(),
#                                     "config/config.yaml"),
#                           eval.expr = T)
# 
# # Combine required params from config
# params <- c(config$common, config$DESeq2)
# # replace nulls in params with NA
# params <- replace_nulls_in_config(params)
# # If projectdir is not set, figure out current project root directory
# projectdir <- params$projectdir
# if (is.na(projectdir)) {
#   projectdir <- here::here()
#   params$projectdir <- projectdir
# }
# 
# paths <- set_up_paths(params)
# 
# 
# skip_extra <- c("DMSO") # Remove DMSO controls as a facet
# 
# # Input file - Rmd
# inputFile <- file.path(projectdir, "Rmd", "DESeq2_report_new.Rmd")
# 
# # Identify where metadata can be found
# SampleKeyFile <- file.path(projectdir, "data/metadata/metadata.QC_applied.txt")
# 
# params$dataFile <- file.path(paths$DEG_output, paste0(params$project_name, "_DEG_data.RData"))

#########################################

species_data <- load_species(params$species)

bs <- load_biospyder_new(params$biospyder_dbs, species_data$temposeq_manifest)


```


# `r params$project_title` - Extra stats {-}

Date report generated: `r format(Sys.time(), '%d %B, %Y')`  
Report prepared for: `r params$project_name`


***

This report contains extra statistics and plots.

```{r load_facet_data, include=FALSE}
source(here::here("scripts","load-facet-data.R"))
```

# Metadata tables
```{r tables, collapse=TRUE}

# table of sample metadata
metadata_table <- DESeqDesign %>% arrange(!!sym(params$design))
knitr::kable(metadata_table,
             row.names =  F,
             caption = "Sample metadata") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  scroll_box(width = "100%", height = "480px")

# table of contrasts
knitr::kable(contrasts,
             row.names =  F,
             caption = "Sample metadata") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  scroll_box(width = "100%", height = "480px")

# table of #samples/group
nSamples_table <- table(metadata_table %>% dplyr::pull(!!sym(params$design))) 
knitr::kable(nSamples_table,
             row.names =  F,
             caption = "Sample metadata") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  scroll_box(width = "100%", height = "480px")

# table of #DEGs/contrast 
summary_counts <- data.frame()
comparisons <- names(resultsListDEGs)
for(comp in comparisons){ # by comparison
    res <- resultsListDEGs[[comp]]
    c <- nrow(res)
    row <- data.frame(comparison=comp, DEG=c)
    summary_counts <- rbind(summary_counts, row)
}

knitr::kable(summary_counts,
             row.names =  F,
             caption = "Sample metadata") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  scroll_box(width = "100%", height = "480px")



```


# Descriptive plots

## boxplots of reads/sample (by group)
```{r nReads_boxplot, collapse=TRUE}
df<-data.frame(colSums(counts(dds)))
names(df) <- c("nReads")
df$original_names = rownames(df)
df2 <- df %>%
    left_join(DESeqDesign) %>%
    dplyr::select(original_names,sym(design_to_use),nReads)

ggplot(df2, aes_string(x=design_to_use, y="nReads") )+
    geom_boxplot() +
    xlab("Group") +
    ylab("Number of reads") +
    theme_bw()

```

## sample-to-sample heatmaps
```{r sample-to-sample_heatmaps}

plot_sample_heatmap <- function(current_rld){
  ## Obtain the sample euclidean distances
  sampleDists <- stats::dist(t(assay(current_rld)))
  sampleDists <- dendextend::sort_dist_mat(sampleDists)
  sampleDistMatrix <- as.matrix(sampleDists)
  
  distances_df <- as.data.frame(colData(current_rld)[, intgroup, drop = F])
  
  ## Define colors to use for the heatmap
  colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
  
  ## Make the heatmap
  return( pheatmap(sampleDistMatrix,
           clustering_distance_rows = sampleDists,
           clustering_distance_cols = sampleDists,
           color = colors,
           annotation_col = distances_df) )
}
# all genes
plot_sample_heatmap(rld)

# DEGs only
plot_sample_heatmap(rld_DEGs)

# 100 most variable genes
plot_sample_heatmap(rld_top)
```

## P-value distributions
```{r pvalue_distribution}
ggplot(data.frame(allResults), aes(x = pvalue)) +
    geom_histogram(alpha = .5, position = 'identity', bins = 50) +
    labs(title = 'Histogram of unadjusted p-values') +
    xlab('Unadjusted p-values') +
    facet_wrap( ~ contrast, ncol = 2)
```

## MA plots
```{r MA_plots}
foldchangestats <- boxplot(abs(allResults$log2FoldChange), plot = F)
ylims_for_ma_plots <- c(-foldchangestats$stats[4, 1], foldchangestats$stats[4, 1])


for (i in seq_along(resultsListAll)) {
  contrast = gsub(pattern = paste0("log2.*", params$design, "\ "),
                  replacement =  "",
                  x = resultsListAll[[i]]@elementMetadata[[2]][2])
  cat("###", contrast, "  \n\n")
  MA_title <- paste0('MA plot, alpha = ', metadata(resultsListAll[[i]])$alpha,', ', contrast)
  DESeq2::plotMA(resultsListAll[[i]],
                 alpha = metadata(resultsListAll[[i]])$alpha,
                 main = str_wrap(MA_title, width = 40),
                 ylim = ylims_for_ma_plots)
  cat('  \n\n')
}

```


# Session Info

## Date the report was generated.

```{r reproducibility1, echo = FALSE}
## Date the report was generated
Sys.time()
```

## Version of R-ODAF Repository

The git hash for the commit of the [R-ODAF repository](`r system("git remote get-url origin", intern = T)`) used in this analysis is `r system("git rev-parse HEAD", intern = T)`.

## Parameters Used

From the list elements in each params${variable} used to generate this report.

```{r paramsList, echo = FALSE}
df <- as.data.frame(unlist(params))
names(df) <- "Parameter Value"
knitr::kable(as.data.frame(df), format = "markdown")
```

## Wallclock time spent generating the report.

```{r reproducibility2, echo = FALSE}
## Processing time in seconds
totalTime <- diff(c(startTime, Sys.time()))
round(totalTime, digits = 3)
```

## `R` session information.

```{r reproducibility3, echo = FALSE}
## Session info
options(width = 120)
session_info()
```

## Pandoc version used: `r rmarkdown::pandoc_version()`.

